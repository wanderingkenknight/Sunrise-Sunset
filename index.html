<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sun &amp; Moon Azimuth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#222" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
    .inputs { background: #fff; padding: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 10px; }
    .inputs label { flex: 1 1 150px; display: flex; flex-direction: column; font-size: 0.9em; }
    .inputs button { flex: 1 1 120px; align-self: flex-end; padding: 10px; font-size: 1em; }
    #map { flex: 1; }
    #output { background: #fff; padding: 12px; font-size: 0.95em; box-shadow: 0 -1px 4px rgba(0,0,0,0.1); }
    @media (max-width: 600px) { .inputs { flex-direction: column; } }
  </style>
</head>
<body>

  <div class="inputs">
    <label>Latitude<input id="lat" type="number" step="0.0001" value="40.7128"></label>
    <label>Longitude<input id="lng" type="number" step="0.0001" value="-74.0060"></label>
    <label>Date<input id="date" type="date"></label>
    <label>Show<select id="mode">
      <option value="both">Sun & Moon</option>
      <option value="sun">Sun only</option>
      <option value="moon">Moon only</option>
    </select></label>
    <button id="locBtn">üìç My Location</button>
  </div>

  <div id="map"></div>
  <div id="output">Loading...</div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([40.7128, -74.0060], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const latI = document.getElementById('lat'),
          lngI = document.getElementById('lng'),
          dateI = document.getElementById('date'),
          modeI = document.getElementById('mode'),
          locBtn = document.getElementById('locBtn'),
          output = document.getElementById('output');

    // Set default date to today
    dateI.value = new Date().toISOString().split('T')[0];

    // Format time safely
    function formatTime(d) {
      return d ? luxon.DateTime.fromJSDate(d).toFormat('HH:mm') : '‚Äî';
    }
    function phaseName(p) {
      if (p < 0.03 || p > 0.97) return 'New Moon';
      if (p < 0.22) return 'Waxing Crescent';
      if (p < 0.28) return 'First Quarter';
      if (p < 0.47) return 'Waxing Gibbous';
      if (p < 0.53) return 'Full Moon';
      if (p < 0.72) return 'Waning Gibbous';
      if (p < 0.78) return 'Last Quarter';
      return 'Waning Crescent';
    }

    let layers = [];
    function clearLayers() {
      layers.forEach(l => map.removeLayer(l));
      layers = [];
    }

    function drawArrow(lat, lng, az, label, color) {
      const len = 0.008;
      const rad = az * Math.PI / 180;
      const dy = len * Math.cos(rad);
      const dx = len * Math.sin(rad);
      const pts = [[lat, lng], [lat + dy, lng + dx]];
      const line = L.polyline(pts, { color, weight: 3 }).addTo(map)
                  .bindTooltip(label, { permanent: true, direction: 'right' });
      layers.push(line);
    }

    function update() {
      const lat = parseFloat(latI.value), lng = parseFloat(lngI.value),
            dateStr = dateI.value;
      if (!dateStr) {
        output.textContent = 'Please select a date';
        return;
      }
      const date = new Date(dateStr + 'T12:00:00');
      const mode = modeI.value;

      const times = SunCalc.getTimes(date, lat, lng);
      const sunRisePos = SunCalc.getPosition(times.sunrise, lat, lng);
      const sunSetPos = SunCalc.getPosition(times.sunset, lat, lng);
      const moonT = SunCalc.getMoonTimes(date, lat, lng);
      const moonRisePos = moonT.rise ? SunCalc.getMoonPosition(moonT.rise, lat, lng) : null;
      const moonSetPos = moonT.set ? SunCalc.getMoonPosition(moonT.set, lat, lng) : null;
      const moonIll = SunCalc.getMoonIllumination(date);

      clearLayers();

      let html = '';
      if (mode === 'sun' || mode === 'both') {
        drawArrow(lat, lng, sunRisePos.azimuth * 180/Math.PI + 180, ' Sunrise', 'orange');
        drawArrow(lat, lng, sunSetPos.azimuth * 180/Math.PI + 180, ' Sunset', 'purple');
        html += `<b>üåÖ Sunrise:</b> ${formatTime(times.sunrise)} (${Math.round(sunRisePos.azimuth*180/Math.PI+180)}¬∞)<br>`;
        html += `<b>üåá Sunset:</b> ${formatTime(times.sunset)} (${Math.round(sunSetPos.azimuth*180/Math.PI+180)}¬∞)<br>`;
        html += `<b>üåå Civil Dawn:</b> ${formatTime(times.civilDawn)} &nbsp; <b>Civil Dusk:</b> ${formatTime(times.civilDusk)}<br><br>`;
      }
      if (mode === 'moon' || mode === 'both') {
        if (moonRisePos) drawArrow(lat, lng, moonRisePos.azimuth * 180/Math.PI + 180, ' Moonrise', 'blue');
        if (moonSetPos) drawArrow(lat, lng, moonSetPos.azimuth * 180/Math.PI + 180, ' Moonset', 'darkblue');
        html += `<b>üåô Moonrise:</b> ${formatTime(moonT.rise)} (${moonRisePos ? Math.round(moonRisePos.azimuth*180/Math.PI+180)+'¬∞' : '‚Äî'})<br>`;
        html += `<b>üåô Moonset:</b> ${formatTime(moonT.set)} (${moonSetPos ? Math.round(moonSetPos.azimuth*180/Math.PI+180)+'¬∞' : '‚Äî'})<br>`;
        html += `<b>Moon Phase:</b> ${phaseName(moonIll.phase)} (${Math.round(moonIll.fraction*100)}% illum.)<br>`;
      }

      output.innerHTML = html;
      map.setView([lat, lng], 13);
    }

    // Event listeners
    [latI, lngI, dateI, modeI].forEach(el => el.addEventListener('change', update));
    locBtn.addEventListener('click', () => {
      navigator.geolocation.getCurrentPosition(pos => {
        latI.value = pos.coords.latitude.toFixed(4);
        lngI.value = pos.coords.longitude.toFixed(4);
        update();
      }, () => alert("Cannot access location."));
    });

    update();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(console.warn);
    }
  </script>
</body>
</html>