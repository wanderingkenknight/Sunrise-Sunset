<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sun & Moon Azimuth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#222">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { margin: 0; background: #f5f5f5; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
    .inputs { background: #fff; padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between; }
    .inputs label { flex: 1 1 150px; font-size: 0.9em; display: flex; flex-direction: column; }
    .inputs button { flex: 1 1 100px; margin-top: 24px; }
    #map { flex-grow: 1; }
    #output { padding: 10px; background: #fff; font-size: 0.95em; }
    @media (max-width: 600px) { .inputs { flex-direction: column; } }
  </style>
</head>
<body>

<div class="inputs">
  <label>Latitude <input id="lat" type="number" step="0.0001" value="40.7128"></label>
  <label>Longitude <input id="lng" type="number" step="0.0001" value="-74.0060"></label>
  <label>Date <input id="date" type="date"></label>
  <label>Show
    <select id="mode">
      <option value="both">Sun & Moon</option>
      <option value="sun">Sun only</option>
      <option value="moon">Moon only</option>
    </select>
  </label>
  <button onclick="useCurrentLocation()">üìç My Location</button>
</div>

<div id="map"></div>
<div id="output">Loading‚Ä¶</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>

<script>
  const map = L.map('map').setView([40.7128, -74.0060], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const latI = document.getElementById('lat');
  const lngI = document.getElementById('lng');
  const dateI = document.getElementById('date');
  const modeI = document.getElementById('mode');
  const output = document.getElementById('output');

  dateI.valueAsDate = new Date();

  function fmt(d, zone) {
    return d ? luxon.DateTime.fromJSDate(d).setZone(zone).toFormat('HH:mm') : '‚Äî';
  }

  function moonPhaseName(p) {
    if (p < 0.03 || p > 0.97) return 'New Moon';
    if (p < 0.22) return 'Waxing Crescent';
    if (p < 0.28) return 'First Quarter';
    if (p < 0.47) return 'Waxing Gibbous';
    if (p < 0.53) return 'Full Moon';
    if (p < 0.72) return 'Waning Gibbous';
    if (p < 0.78) return 'Last Quarter';
    return 'Waning Crescent';
  }

  let arrows = [];
  function clearArrows() { arrows.forEach(a=>map.removeLayer(a)); arrows=[]; }

  function drawArrow(lat, lng, az, label, color) {
    const len = 0.01;
    const ang = az*Math.PI/180;
    const dx = len*Math.sin(ang);
    const dy = len*Math.cos(ang);
    const arrow = L.polyline([[lat, lng], [lat+dx, lng+dy]], { color, weight: 3 }).addTo(map);
    arrow.bindTooltip(label, { permanent: true, direction: 'right', className: 'arrow-label' });
    arrows.push(arrow);
  }

  function update() {
    const lat = +latI.value, lng = +lngI.value;
    const dateVal = dateI.value;
    if (!dateVal) return;
    const date = new Date(dateVal + 'T12:00:00');
    const zone = luxon.DateTime.local().zoneName;
    const mode = modeI.value;
    const times = SunCalc.getTimes(date, lat, lng);
    const sRise = SunCalc.getPosition(times.sunrise, lat, lng);
    const sSet = SunCalc.getPosition(times.sunset, lat, lng);
    const mT = SunCalc.getMoonTimes(date, lat, lng);
    const mRise = mT.rise && SunCalc.getMoonPosition(mT.rise, lat, lng);
    const mSet = mT.set && SunCalc.getMoonPosition(mT.set, lat, lng);
    const mIll = SunCalc.getMoonIllumination(date);

    clearArrows();

    let html = '';
    if (mode==='sun' || mode==='both') {
      drawArrow(lat, lng, sRise.azimuth*180/Math.PI+180, ' Sunrise','orange');
      drawArrow(lat, lng, sSet.azimuth*180/Math.PI+180, ' Sunset','purple');
      html += `<b>üåÖ Sunrise:</b> ${fmt(times.sunrise, zone)} (${Math.round(sRise.azimuth*180/Math.PI+180)}¬∞)<br>`;
      html += `<b>üåá Sunset:</b> ${fmt(times.sunset, zone)} (${Math.round(sSet.azimuth*180/Math.PI+180)}¬∞)<br>`;
      html += `<b>üåå Civil Dawn:</b> ${fmt(times.civilDawn, zone)} &nbsp; <b>Civil Dusk:</b> ${fmt(times.civilDusk, zone)}<br><br>`;
    }
    if (mode==='moon' || mode==='both') {
      if (mRise) drawArrow(lat, lng, mRise.azimuth*180/Math.PI+180, ' Moonrise','blue');
      if (mSet) drawArrow(lat, lng, mSet.azimuth*180/Math.PI+180, ' Moonset','darkblue');
      html += `<b>üåô Moonrise:</b> ${fmt(mT.rise, zone)} (${mRise?Math.round(mRise.azimuth*180/Math.PI+180)+'¬∞':'‚Äî'})<br>`;
      html += `<b>üåô Moonset:</b> ${fmt(mT.set, zone)} (${mSet?Math.round(mSet.azimuth*180/Math.PI+180)+'¬∞':'‚Äî'})<br>`;
      html += `<b>Moon Phase:</b> ${moonPhaseName(mIll.phase)} (${Math.round(mIll.fraction*100)}% illuminated)<br>`;
    }

    output.innerHTML = html;
    map.setView([lat, lng], 13);
  }

  latI.addEventListener('change', update);
  lngI.addEventListener('change', update);
  dateI.addEventListener('change', update);
  modeI.addEventListener('change', update);

  function useCurrentLocation() {
    navigator.geolocation.getCurrentPosition(p => {
      latI.value = p.coords.latitude.toFixed(4);
      lngI.value = p.coords.longitude.toFixed(4);
      update();
    }, () => alert('Unable to fetch location'));
  }

  update();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .catch(e => console.warn('SW registration failed', e));
  }
</script>

</body>
</html>